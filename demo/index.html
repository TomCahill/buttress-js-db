<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    
    <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>

    <title>buttress-db demo</title>
  </head>
  <body>
    <buttress-demo-element></buttress-demo-element>

    <script type="module">
      import {PolymerElement, html} from '@polymer/polymer/polymer-element.js';
      import '@polymer/polymer/lib/elements/dom-repeat.js';
      import {Buttress} from '../buttress-db.js';

      class DemoElement extends PolymerElement {
        static get is() { return `buttress-demo-element`; }
        static get properties () {
          return {
            apiEndpoint: {
              type: String,
              value: 'https://test.local.buttressjs.com',
            },
            apiAppId: String,
            apiPath: {
              type: String,
              value: 'bjs',
            },

            token: String,
            userId: String,

            dbLoaded: Boolean,
            dbLoading: Object,
            dbError: Boolean,
            dbSettings: Object,

            db: Object,
            io: Object,

            loadOnStartup: {
              type: Array,
              value: function() {
                return ["post"]
              }
            }
          };
        }
        static get template() {
          return html`
            <style>
              .props {
                margin: 0;
                background-color: #f5f5f5;
                font-size: 1rem 0.5rem;
                padding: 20px;
              }
              .props .prop {
                margin-left: 0.5rem;
              }

              .ph-1 {
                padding: 0 1rem;
              }

              .flex {
                display: flex;
              }
              .horizontal {
                flex-direction: row;
              }
              .vertical {
                flex-direction: column;
              }
              .wrap {
                flex-wrap: wrap;
              }
              .flow {
                flex: 1;
              }

            </style>
            <buttress-db
              id="bjs"
              endpoint="[[apiEndpoint]]",
              app-id="[[apiAppId]]",
              api-path="[[apiPath]]",
              user-id="[[userId]]",
              token="[[token]]",
              loaded="{{dbLoaded}}",
              loading="{{dbLoading}}",
              error="{{dbError}}",
              settings="{{dbSettings}}",
              load-on-startup="[[loadOnStartup]]",
              db="{{db}}",
              io="{{io}}",
              logging
            ></buttress-db>

            <button on-click="_doPostAddition">Single Addition</button>
            <button on-click="_doManyPostAdditions">Many Additions</button>
            <button on-click="_doPostModification">Single Modification</button>
            <button on-click="_doManyPostModifications">Many Modification</button>

            <button on-click="_toggleBundling">Bundling: [[dbSettings.bundled_requests]] </button>
            <div class="flex horizontal">
              <div class="flow vertical flex ph-1">
                <h4>Details</h4>
                <input id="apiEndpoint" placeholder="API Endpoint" value="[[apiEndpoint]]" />
                <input id="apiAppId" placeholder="API App Id" value="[[apiAppId]]" />
                <input id="apiPath" placeholder="API Path" value="[[apiPath]]" />
                <input id="userId" placeholder="User Id" value="[[userId]]" />
                <input id="token" placeholder="Token" value="[[token]]" />
                <input type="submit" value="Save" on-click="_doSubmit"/>
              </div>

              <div class="flow vertical flex ph-1">
                <h4>Actions</h4>
                <button on-click="_doPostAddition">Single Addition</button>
                <button on-click="_doManyPostAdditions">Many Additions</button>
                <button on-click="_doPostModification">Single Modification</button>
                <button on-click="_doManyPostModifications">Many Modification</button>
              </div>
            </div>
            <div class="vertical-section-container centered">
              <h1>Basic buttress-db demo: [[token]]</h1>
              <pre>
                Posts Count: [[db.post.data.length]]
              </pre>
              <h3>Properties</h3>
              <div class="props vertical">
                <pre class="prop"><b>loaded</b>: [[dbLoaded]]</pre>
                <pre class="prop"><b>loading</b>: [[stringify(dbLoading, dbLoading.*)]]</pre>
                <pre class="prop"><b>error</b>: [[dbError]]</pre>
                <pre class="prop"><b>settings</b>: [[stringify(dbSettings, dbSettings.*)]]</pre>
                <pre class="prop"><b>io</b>: [[stringify(io, io.*)]]</pre>
              </pre>
            </div>
          `;
        }
        ready() {
          super.ready();

          this._localRead('apiEndpoint');
          this._localRead('apiAppId');
          this._localRead('apiPath');
          this._localRead('userId');
          this._localRead('token');
        }

        _localRead(key) {
          if (window.localStorage.getItem(key)) {
            this.set(key, window.localStorage.getItem(key));
          }
        }
        _localWrite(key, value) {
          window.localStorage.setItem(key, value);
          this.set(key, value);
        }

        _changeToken(ev) {
          this.set('token', this.$.selectToken.value);
          localStorage.setItem('token', this.$.selectToken.value);
        }

        _doPostAddition(n) {
          if (typeof n !== "number") n = 1;

          const dummyText = `Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.` +
                            `Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure` +
                            `dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident,` +
                            `sunt in culpa qui officia deserunt mollit anim id est laborum.`;

          for (let x = 0; x < n; x++) {
            const post = Buttress.AppDb.Factory.create('posts');

            post.content = dummyText

            Buttress.pushPath('db.post.data', post);
          }
        }
        _doManyPostAdditions() {
          this._doPostAddition(100);
        }

        _doPostModification(n) {
          if (typeof n !== "number") n = 1;

          // const rdmBool = () => Math.round(Math.random() * 1) === 1;
          const rdmBool = () => true;

          for (let x = 0; x < n; x++) {
            const randomIdx = Math.floor(Math.random() * Buttress.getPath('db.post.data.length'));

            // const post = Buttress.AppDb.Factory.create('posts');

            // post.content = dummyText
            if (rdmBool()) {
              Buttress.setPath(`db.post.data.${randomIdx}.kudos`, Math.round(Math.random() * 999));
            }
            if (rdmBool()) {
              Buttress.setPath(`db.post.data.${randomIdx}.views`, Math.round(Math.random() * 999));
            }

            // Buttress.setPath(`db.post.data.${randomIdx}.kudos`, post);
            // Buttress.setPath(`db.post.data.${randomIdx}.kudos`, post);
            // Buttress.setPath(`db.post.data.${randomIdx}.kudos`, post);
          }
        }
        _doManyPostModifications() {
          this._doPostModification(100);
        }
        _doSubmit() {
          this._localWrite('apiEndpoint', this.$.apiEndpoint.value);
          this._localWrite('apiAppId', this.$.apiAppId.value);
          this._localWrite('apiPath', this.$.apiPath.value);
          this._localWrite('userId', this.$.userId.value);
          this._localWrite('token', this.$.token.value);
        }

        _toggleBundling() {
          this.set('dbSettings.bundled_requests', !this.get('dbSettings.bundled_requests'));
        }

        stringify(object) {
          return JSON.stringify(object, null, 4);
        }
      }
      customElements.define(DemoElement.is, DemoElement);
    </script>
  </body>
</html>
